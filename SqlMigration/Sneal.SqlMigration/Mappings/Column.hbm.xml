<?xml version="1.0"?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="Sneal.SqlMigration" namespace="Sneal.SqlMigration.Impl">

  <class name="Column">
    <composite-id>
      <key-property name="Name" column="COLUMN_NAME"/>
      <key-many-to-one name="Table" class="Table" column="TABLE_NAME" />
    </composite-id>
    <property name="Schema" column="TABLE_SCHEMA" not-null="true"/>
    <property name="IsNullable" column="IS_NULLABLE" not-null="true"/>
    <property name="Default" column="COLUMN_DEFAULT" not-null="false"/>
    <component name="DataType" class="Sneal.SqlMigration.SqlDataType, Sneal.SqlMigration">
      <property name="Name" column="DATA_TYPE"/>
      <property name="Length" column="CHARACTER_MAXIMUM_LENGTH"/>
    </component>
    <many-to-one name="ForeignKey" class="ForeignKey" column="CONSTRAINT_NAME"/>
    <loader query-ref="Column"/>
  </class>

  <sql-query name="Column">
    <load-collection alias="col" role="Table.Columns"/>
    SELECT c.TABLE_SCHEMA, c.TABLE_NAME,
    c.COLUMN_NAME, c.DATA_TYPE,
    c.CHARACTER_MAXIMUM_LENGTH,
    c.COLUMN_DEFAULT,
    CASE c.IS_NULLABLE
    WHEN 'YES' THEN 1
    ELSE 0
    END AS 'IS_NULLABLE',
    ccu.CONSTRAINT_NAME
    FROM INFORMATION_SCHEMA.COLUMNS c
    LEFT JOIN INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE ccu
    ON ccu.COLUMN_NAME = c.COLUMN_NAME AND ccu.TABLE_NAME = c.TABLE_NAME
    AND ccu.CONSTRAINT_NAME IN
    (SELECT rc.CONSTRAINT_NAME FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS rc)
    WHERE c.TABLE_NAME = ?
  </sql-query>

</hibernate-mapping>